diff --git a/src/components/workbench/world-map-view.tsx b/src/components/workbench/world-map-view.tsx
index d1ea07b..c44843e 100644
--- a/src/components/workbench/world-map-view.tsx
+++ b/src/components/workbench/world-map-view.tsx
@@ -2,14 +2,13 @@
 
 import React, { useEffect, useRef, useState } from 'react';
 import * as d3 from 'd3';
-import { Search, RefreshCw, ZoomIn, ZoomOut, Maximize, Globe, GitCompare, ChevronDown, ChevronRight, ChevronUp } from 'lucide-react';
+import { Search, RefreshCw, ZoomIn, ZoomOut, Maximize, Globe, GitCompare } from 'lucide-react';
 import { Button as UIButton } from '@/components/ui/button';
 import { useStreamContext } from '@/providers/Stream';
 import { useQueryState } from 'nuqs';
 import { useMemo } from 'react';
 import { cn } from '@/lib/utils';
 import { KG_DIFF_COLORS } from '@/lib/diff-types';
-import { getWorkflowNodeColor } from '@/lib/workflow-agent-colors';
 import { NodeDetailPanel } from './node-detail-panel';
 import { ArtifactsListView } from './artifacts-list-view';
 import { useUnifiedPreviews } from './hooks/use-unified-previews';
@@ -44,119 +43,17 @@ interface GraphData {
     };
 }
 
-/** Type ΓåÆ display label (for legend and fallback). */
 const typeConfig: Record<string, { color: string; label: string }> = {
     DOMAIN: { color: '#64748b', label: 'Domain' },
     REQ: { color: '#fbbf24', label: 'Trigger' },
     ARTIFACT: { color: '#0ea5e9', label: 'Artifact' },
     MECH: { color: '#a855f7', label: 'Mechanism' },
     CRIT: { color: '#f43f5e', label: 'Risk' },
-    COMPONENT: { color: '#06b6d4', label: 'Component' },
-    VIEW: { color: '#22c55e', label: 'View' },
-    REQUIREMENT: { color: '#eab308', label: 'Requirement' },
-    SCENARIO: { color: '#ec4899', label: 'Scenario' },
-    INTERFACE: { color: '#8b5cf6', label: 'Interface' },
-    DECISION: { color: '#f97316', label: 'Decision' },
-    PERSONA: { color: '#ec4899', label: 'Persona' },
-    PERS: { color: '#ec4899', label: 'Persona' },
-    OUTCOME: { color: '#22c55e', label: 'Outcome' },
-    OUT: { color: '#22c55e', label: 'Outcome' },
-    METRIC: { color: '#06b6d4', label: 'Metric' },
-    MET: { color: '#06b6d4', label: 'Metric' },
-    CONSTRAINT: { color: '#8b5cf6', label: 'Constraint' },
-    CONST: { color: '#8b5cf6', label: 'Constraint' },
-    FEATURE: { color: '#eab308', label: 'Feature' },
-    FEAT: { color: '#eab308', label: 'Feature' },
-    JTBD: { color: '#a855f7', label: 'JTBD' },
-    UXO: { color: '#0ea5e9', label: 'UX Outcome' },
-    LIFECYCLE: { color: '#64748b', label: 'Lifecycle' },
-    TEMPLATE: { color: '#64748b', label: 'Template' },
 };
 
-/** Agent ΓåÆ Template ΓåÆ NodeTypes hierarchy (aligns with ArtifactTemplates_kg). Colour is at Agent level. */
-const MAP_LEGEND_AGENT_HIERARCHY: {
-    agentId: string;
-    agentName: string;
-    templates: { templateName: string; types: string[] }[];
-}[] = [
-    {
-        agentId: 'concept',
-        agentName: 'Concept',
-        templates: [
-            { templateName: 'Concept Brief', types: ['PERSONA', 'PERS', 'SCENARIO', 'OUTCOME', 'OUT', 'METRIC', 'MET', 'DECISION', 'CONSTRAINT', 'CONST'] },
-            { templateName: 'Feature Definition', types: ['FEATURE', 'FEAT', 'JTBD'] },
-            { templateName: 'UX Brief', types: ['UXO'] },
-        ],
-    },
-    {
-        agentId: 'requirements',
-        agentName: 'Requirements',
-        templates: [
-            { templateName: 'Requirements Package', types: ['REQUIREMENT', 'LIFECYCLE', 'SCENARIO'] },
-        ],
-    },
-    {
-        agentId: 'architecture',
-        agentName: 'Architecture',
-        templates: [
-            { templateName: 'Architecture', types: ['COMPONENT', 'INTERFACE', 'VIEW'] },
-        ],
-    },
-    {
-        agentId: 'design',
-        agentName: 'Design',
-        templates: [
-            { templateName: 'Design', types: ['COMPONENT', 'INTERFACE', 'REQUIREMENT', 'DECISION'] },
-        ],
-    },
-    {
-        agentId: 'system',
-        agentName: 'System',
-        templates: [
-            { templateName: 'Methodology / KG', types: ['DOMAIN', 'REQ', 'ARTIFACT', 'MECH', 'CRIT', 'TEMPLATE'] },
-        ],
-    },
-];
-
-/** Node type ΓåÆ agent id (for agent-level colour). First match in hierarchy wins. */
-const typeToAgentId: Record<string, string> = (() => {
-    const out: Record<string, string> = {};
-    for (const agent of MAP_LEGEND_AGENT_HIERARCHY) {
-        for (const t of agent.templates) {
-            for (const typeName of t.types) {
-                if (!(typeName in out)) out[typeName] = agent.agentId;
-            }
-        }
-    }
-    return out;
-})();
-
-/** Brand hue (customer brand); light ΓåÆ dark = start ΓåÆ finish. */
-const MAP_LEGEND_BRAND_HUE = 217;
-/** Agent-level colours: same hue, light (start) ΓåÆ dark (finish). */
-const agentColors: Record<string, string> = {
-    concept: `hsl(${MAP_LEGEND_BRAND_HUE}, 45%, 72%)`,
-    requirements: `hsl(${MAP_LEGEND_BRAND_HUE}, 50%, 58%)`,
-    architecture: `hsl(${MAP_LEGEND_BRAND_HUE}, 55%, 48%)`,
-    design: `hsl(${MAP_LEGEND_BRAND_HUE}, 55%, 38%)`,
-    system: 'hsl(215, 15%, 45%)',
-};
-
-function getAgentColorForNodeType(nodeType: string): string {
-    const agentId = typeToAgentId[nodeType];
-    return agentId ? agentColors[agentId] ?? '#888' : '#888';
-}
-
-export interface WorldMapViewProps {
-    /** When true, the decisions table on the left is the timeline; hide the built-in timeline panel. */
-    embeddedInDecisions?: boolean;
-}
-
-export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps = {}) {
+export function WorldMapView() {
     const stream = useStreamContext();
     const [viewMode, setViewMode] = useQueryState("view", { defaultValue: "map" });
-    const [compareParam] = useQueryState("compare"); // When "1" or "true", open timeline (header "Compare on map")
-    const [versionParam] = useQueryState("version"); // Select this decision version in timeline and show its diff (per-decision "Compare on map")
     /** Filtered KG streamed from backend when Project Configurator runs; use for map without extra /api/kg-data. */
     const filteredKg = (stream as any)?.values?.filtered_kg as { nodes: any[]; links: any[]; metadata?: any } | undefined;
 
@@ -177,112 +74,29 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
     const [activeVersion, setActiveVersion] = useState<string | null>(null);
     const [inactiveOpacity, setInactiveOpacity] = useState(0.15); // Transparency for inactive nodes (0-1)
     const [compareMode, setCompareMode] = useState(false);
-
-    // Open timeline when arriving via shortcut (e.g. ?compare=1 from header "Compare on map")
-    useEffect(() => {
-        if (compareParam === "1" || compareParam === "true") {
-            setShowHistory(true);
-        }
-    }, [compareParam]);
-    // When version= in URL (per-decision "Compare on map"), open timeline, select that version, show its diff
-    const lastUrlVersion = useRef<string | null>(null);
-    useEffect(() => {
-        if (!versionParam || !threadId) return;
-        if (!kgHistory?.versions?.length) {
-            console.log('[WorldMapView] Timeline diff: version= in URL but no kgHistory yet, fetching history');
-            fetchKgHistory();
-            return;
-        }
-        const versions = kgHistory.versions as { id?: string }[];
-        const idx = versions.findIndex((v) => v.id === versionParam);
-        const versionBefore = idx >= 0 && idx < versions.length - 1 ? versions[idx + 1]?.id : undefined;
-        console.log('[WorldMapView] Timeline diff: version= in URL', {
-            versionParam,
-            threadId,
-            versionsCount: versions.length,
-            idx,
-            versionBefore: versionBefore ?? null,
-            willFetchDiff: lastUrlVersion.current !== versionParam && !!versionBefore,
-        });
-        setShowHistory(true);
-        setCompareMode(false);
-        setSelectedTimelineVersionId(versionParam);
-        setActiveVersion(versionParam);
-        if (lastUrlVersion.current !== versionParam) {
-            lastUrlVersion.current = versionParam;
-            fetchDiffForTimelineVersion(versionParam);
-        }
-        fetchData(versionParam);
-    }, [versionParam, threadId, kgHistory]);
     const [compareVersion1, setCompareVersion1] = useState<string | null>(null);
     const [compareVersion2, setCompareVersion2] = useState<string | null>(null);
     const [diffData, setDiffData] = useState<any>(null);
     const [loadingDiff, setLoadingDiff] = useState(false);
     /** When in compare mode: 'graph' = force-directed map with diff colors; 'diff' = KgDiffDiagramView (list by change type). Harmonized with KG_DIFF_CONTRACT. */
     const [compareViewMode, setCompareViewMode] = useState<'graph' | 'diff'>('graph');
-    /** Timeline view: version selected for showing its introduced diff (before ΓåÆ this version). */
-    const [selectedTimelineVersionId, setSelectedTimelineVersionId] = useState<string | null>(null);
-    const [timelineVersionDiff, setTimelineVersionDiff] = useState<any>(null);
-    const [loadingTimelineDiff, setLoadingTimelineDiff] = useState(false);
-
-    /** Map search: single match ΓåÆ select node; multiple ΓåÆ filtered view. */
-    const [mapSearchQuery, setMapSearchQuery] = useState('');
-    /** Type filter: record of node type ΓåÆ visible (false = hidden). Empty = all visible. */
-    const [typeFilter, setTypeFilter] = useState<Record<string, boolean>>({});
-    /** Collapsed agent groups in the hierarchical legend (agentId ΓåÆ true = collapsed). */
-    const [legendCollapsed, setLegendCollapsed] = useState<Record<string, boolean>>({});
-    /** Workflow strip for bottom panel (same left-to-right as header). */
-    const [workflowStrip, setWorkflowStrip] = useState<{ nodes: { id: string; label: string }[]; active_node?: string } | null>(null);
-    /** Bottom panel (workflow | filter | search | zoom) collapsed. */
-    const [bottomPanelCollapsed, setBottomPanelCollapsed] = useState(false);
-
-    // Fetch workflow strip for bottom panel (same as header, left-to-right flow)
-    useEffect(() => {
-        if (!threadId || embeddedInDecisions) return;
-        let cancelled = false;
-        const params = new URLSearchParams();
-        const activeAgent = (stream as any)?.values?.active_agent;
-        if (activeAgent) params.set('active_node', activeAgent);
-        fetch(`/api/workflow${params.toString() ? `?${params.toString()}` : ''}`)
-            .then((r) => (r.ok ? r.json() : null))
-            .then((data: { nodes?: { id: string; label: string }[]; active_node?: string } | null) => {
-                if (!cancelled && data?.nodes) setWorkflowStrip({ nodes: data.nodes, active_node: data.active_node });
-                else if (!cancelled) setWorkflowStrip(null);
-            })
-            .catch(() => { if (!cancelled) setWorkflowStrip(null); });
-        return () => { cancelled = true; };
-    }, [threadId, embeddedInDecisions, (stream as any)?.values?.active_agent]);
-
-    useEffect(() => {
-        if (selectedTimelineVersionId) {
-            console.log('[WorldMapView] Timeline diff state', {
-                selectedTimelineVersionId,
-                loadingTimelineDiff,
-                hasDiff: !!timelineVersionDiff?.diff,
-                hasSummary: !!timelineVersionDiff?.summary,
-                nodeCount: timelineVersionDiff?.diff?.nodes?.length ?? 0,
-            });
-        }
-    }, [selectedTimelineVersionId, timelineVersionDiff, loadingTimelineDiff]);
 
     const unifiedPreviews = useUnifiedPreviews();
     const draftArtifactNodes = useMemo(() => {
+        const artifactTypes = new Set([
+            'generate_concept_brief',
+            'generate_requirements_proposal',
+            'generate_architecture_proposal',
+            'generate_design_proposal',
+        ]);
         return unifiedPreviews
-            .filter(
-                (p) =>
-                    p.status === 'pending' &&
-                    p.type === 'generate' &&
-                    (p.data?.args as Record<string, unknown> | undefined)?.artifact_type
-            )
-            .map((p) => {
-                const artifactType = (p.data?.args as Record<string, unknown> | undefined)?.artifact_type as string;
-                return {
-                    id: `draft-${p.id}`,
-                    name: p.title,
-                    type: 'ARTIFACT',
-                    metadata: { draft: true, artifact_types: [artifactType], artifact_id: undefined },
-                };
-            }) as Node[];
+            .filter((p) => p.status === 'pending' && artifactTypes.has(p.type))
+            .map((p) => ({
+                id: `draft-${p.id}`,
+                name: p.title,
+                type: 'ARTIFACT',
+                metadata: { draft: true, artifact_types: [p.type.replace('generate_', '').replace('_proposal', '').replace('_brief', '')], artifact_id: undefined },
+            })) as Node[];
     }, [unifiedPreviews]);
 
     // Note: Workflow workbench view removed; version/orientation is in global header. Artifact history and content fetching is handled by NodeDetailPanel.
@@ -348,46 +162,6 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
         }
     };
 
-    /** Fetch diff for a single timeline version (versionBefore ΓåÆ versionId). Used in timeline view for decision versions. */
-    const fetchDiffForTimelineVersion = async (versionId: string) => {
-        if (!threadId || !kgHistory?.versions?.length) {
-            console.log('[WorldMapView] Timeline diff fetch skipped: no threadId or kgHistory', { threadId: !!threadId, versionsLength: kgHistory?.versions?.length ?? 0 });
-            return;
-        }
-        const versions = kgHistory.versions as { id?: string }[];
-        const idx = versions.findIndex((v) => v.id === versionId);
-        const versionBefore = idx >= 0 && idx < versions.length - 1 ? versions[idx + 1]?.id : undefined;
-        if (!versionBefore) {
-            console.log('[WorldMapView] Timeline diff fetch skipped: no versionBefore', { versionId, idx, versionsLength: versions.length });
-            return;
-        }
-        const url = `/api/project/diff?thread_id=${threadId}&version1=${versionBefore}&version2=${versionId}`;
-        console.log('[WorldMapView] Timeline diff fetch start', { versionId, versionBefore, url });
-        try {
-            setLoadingTimelineDiff(true);
-            const orgContext = localStorage.getItem('reflexion_org_context');
-            const headers: Record<string, string> = {};
-            if (orgContext) headers['X-Organization-Context'] = orgContext;
-            const res = await fetch(url, { headers });
-            if (res.ok) {
-                const diff = await res.json();
-                const hasDiff = !!diff?.diff;
-                const hasSummary = !!diff?.summary;
-                const nodeCount = diff?.diff?.nodes?.length ?? 0;
-                const edgeCount = (diff?.diff?.edges ?? diff?.diff?.links)?.length ?? 0;
-                console.log('[WorldMapView] Timeline diff fetch OK', { versionId, hasDiff, hasSummary, nodeCount, edgeCount, summaryKeys: hasSummary ? Object.keys(diff.summary) : [] });
-                setTimelineVersionDiff(diff);
-            } else {
-                const text = await res.text();
-                console.warn('[WorldMapView] Timeline diff fetch failed', { versionId, status: res.status, body: text.slice(0, 200) });
-            }
-        } catch (e) {
-            console.error('[WorldMapView] Timeline version diff fetch error:', e);
-        } finally {
-            setLoadingTimelineDiff(false);
-        }
-    };
-
     const fetchData = async (version?: string, preserveDiff: boolean = false) => {
         try {
             setLoading(true);
@@ -494,10 +268,9 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
 
         const svgElForCleanup = svgRef.current;
 
-        // When a timeline version is selected, use its diff for semantic coloring on the main graph; otherwise use compare-mode diff.
-        const effectiveDiff = (selectedTimelineVersionId && timelineVersionDiff) ? timelineVersionDiff : diffData;
-        const hasDiff = !!(effectiveDiff?.diff?.nodes?.length && (effectiveDiff?.diff?.links?.length ?? effectiveDiff?.diff?.edges?.length));
-        console.log('[WorldMapView] graph rendering', { nodes: data.nodes?.length, links: data.links?.length, hasDiff, diffSource: selectedTimelineVersionId ? 'timelineVersionDiff' : 'diffData', diffNodes: effectiveDiff?.diff?.nodes?.length, diffEdges: (effectiveDiff?.diff?.links ?? effectiveDiff?.diff?.edges)?.length });
+        // Single prominent log so you can filter console by "WorldMapView" and ignore 404/Stream noise
+        const hasDiff = !!(diffData?.diff?.nodes?.length && (diffData?.diff?.links?.length ?? diffData?.diff?.edges?.length));
+        console.log('[WorldMapView] graph rendering', { nodes: data.nodes?.length, links: data.links?.length, hasDiff, diffNodes: diffData?.diff?.nodes?.length, diffEdges: (diffData?.diff?.links ?? diffData?.diff?.edges)?.length });
 
         const width = containerRef.current.clientWidth;
         const height = containerRef.current.clientHeight;
@@ -528,10 +301,10 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
             .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
             .attr('fill', '#888');
 
-        // In compare mode or timeline-version-selected mode, use the diff payload as the single source of truth for nodes and links
+        // In compare mode, use the diff payload as the single source of truth for nodes and links
         // so link endpoints always match node ids (no orphaned added nodes).
-        const diffEdges = (effectiveDiff?.diff?.links ?? effectiveDiff?.diff?.edges) as Array<{ source?: string | number | { id?: string }; target?: string | number | { id?: string }; changeType?: string; type?: string }> | undefined;
-        const diffNodesList = effectiveDiff?.diff?.nodes as Array<{ id: string; name?: string; changeType?: string; diff_status?: string }> | undefined;
+        const diffEdges = (diffData?.diff?.links ?? diffData?.diff?.edges) as Array<{ source?: string | number | { id?: string }; target?: string | number | { id?: string }; changeType?: string; type?: string }> | undefined;
+        const diffNodesList = diffData?.diff?.nodes as Array<{ id: string; name?: string; changeType?: string; diff_status?: string }> | undefined;
         const useDiffPayload = diffNodesList?.length && diffEdges?.length;
 
         let nodes: Node[];
@@ -562,30 +335,30 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
         }
 
         // If we have diff data but didn't use diff payload (e.g. no edges), merge diff_status into nodes for coloring.
-        if (effectiveDiff && effectiveDiff.diff && effectiveDiff.diff.nodes && !useDiffPayload) {
+        if (diffData && diffData.diff && diffData.diff.nodes && !useDiffPayload) {
             console.log('[WorldMapView] Applying diff visualization (data nodes + diff status):', {
                 diffDataStructure: {
-                    hasDiff: !!effectiveDiff.diff,
-                    hasNodes: !!effectiveDiff.diff.nodes,
-                    nodesLength: effectiveDiff.diff.nodes?.length,
-                    summary: effectiveDiff.summary
+                    hasDiff: !!diffData.diff,
+                    hasNodes: !!diffData.diff.nodes,
+                    nodesLength: diffData.diff.nodes?.length,
+                    summary: diffData.summary
                 },
-                diffNodes: effectiveDiff.diff.nodes.length,
+                diffNodes: diffData.diff.nodes.length,
                 currentNodes: nodes.length,
-                sampleDiffNode: effectiveDiff.diff.nodes[0],
+                sampleDiffNode: diffData.diff.nodes[0],
                 sampleCurrentNode: nodes[0]
             });
             
             // Create maps for both ID and name/label matching (KG-diff contract: changeType or diff_status)
-            const diffNodesById = new Map(effectiveDiff.diff.nodes.map((n: any) => [n.id, n]));
+            const diffNodesById = new Map(diffData.diff.nodes.map((n: any) => [n.id, n]));
             const diffNodesByName = new Map(
-                effectiveDiff.diff.nodes
+                diffData.diff.nodes
                     .filter((n: any) => n.name != null || (n as any).label != null)
                     .map((n: any) => [n.name ?? (n as any).label, n])
             );
             
             // Log detailed structure
-            const sampleDiffNode = effectiveDiff.diff.nodes[0];
+            const sampleDiffNode = diffData.diff.nodes[0];
             const sampleCurrentNode = nodes[0];
             console.log('[WorldMapView] Sample diff node structure:', {
                 id: sampleDiffNode?.id,
@@ -611,7 +384,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
             console.log('[WorldMapView] Matching names:', matchingNames.slice(0, 10));
             
             // Check all diff nodes with their status
-            const diffNodesWithStatus = effectiveDiff.diff.nodes.filter((n: any) => n.diff_status).map((n: any) => ({
+            const diffNodesWithStatus = diffData.diff.nodes.filter((n: any) => n.diff_status).map((n: any) => ({
                 id: n.id,
                 name: n.name || (n as any).label,
                 status: n.diff_status,
@@ -662,10 +435,10 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
             });
         } else {
             console.log('[WorldMapView] No diff data available:', { 
-                effectiveDiff, 
-                hasDiff: !!effectiveDiff?.diff,
-                hasDiffNodes: !!effectiveDiff?.diff?.nodes,
-                diffNodesLength: effectiveDiff?.diff?.nodes?.length
+                diffData: diffData, 
+                hasDiff: !!diffData?.diff,
+                hasDiffNodes: !!diffData?.diff?.nodes,
+                diffNodesLength: diffData?.diff?.nodes?.length
             });
         }
 
@@ -770,7 +543,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
 
         // In diff mode: add anchor links for orphan added nodes so they are pulled into the layout (no floating).
         let validLinks: Link[] = resolvedLinks;
-        if (effectiveDiff && orphanAddedNodes.length > 0) {
+        if (diffData && orphanAddedNodes.length > 0) {
             const anchor = nodes.find((n) => allEndpointIdsFromResolved.has(n.id)) ?? nodes[0];
             if (anchor) {
                 const anchorLinks: Link[] = orphanAddedNodes.map((orphan) => ({
@@ -806,9 +579,9 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
         console.log('[WorldMapView] Endpoint sample (from links) vs node ids:', { endpoints: Array.from(endpointSet).slice(0, 15), nodeIds: nodes.slice(0, 12).map((n: Node) => n.id) });
 
         // Consolidated diff debug: filter console by "WorldMapView" to hide 404/Stream noise
-        if (effectiveDiff) {
+        if (diffData) {
             const added = nodes.filter((n: Node) => (n as any).diff_status === 'added');
-            const summaryFromApi = effectiveDiff.summary ?? (effectiveDiff.diff as any)?.summary ?? {};
+            const summaryFromApi = diffData.summary ?? (diffData.diff as any)?.summary ?? {};
             const _allEndpointIds = allEndpointIdsFromResolved;
             const orphans = orphanNodeIds;
             const linkSample = links.slice(0, 8).map((l: Link) => ({
@@ -819,7 +592,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
             console.log('source', useDiffPayload ? 'diff payload' : 'data + diff status');
             console.log('counts', { nodes: nodes.length, links: links.length, resolved: validLinks.length, dropped: droppedLinks.length });
             console.log('apiSummary', { added: summaryFromApi.added, modified: summaryFromApi.modified, removed: summaryFromApi.removed, total_nodes_v2: summaryFromApi.total_nodes_v2, total_links_v2: summaryFromApi.total_links_v2 });
-            console.log('semanticSummary', (summaryFromApi.semanticSummary ?? (effectiveDiff.diff as any)?.summary?.semanticSummary) ? String(summaryFromApi.semanticSummary ?? (effectiveDiff.diff as any)?.summary?.semanticSummary).slice(0, 200) : undefined);
+            console.log('semanticSummary', (summaryFromApi.semanticSummary ?? (diffData.diff as any)?.summary?.semanticSummary) ? String(summaryFromApi.semanticSummary ?? (diffData.diff as any)?.summary?.semanticSummary).slice(0, 200) : undefined);
             console.log('added nodes (ids)', added.map((n: Node) => n.id));
             console.log('orphans (nodes with no link endpoint)', orphans.length ? orphans : 'none');
             if (orphans.length) console.warn('orphan node ids', orphans);
@@ -827,41 +600,8 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
             console.groupEnd();
         }
 
-        // Type filter: show only nodes whose type is not explicitly hidden (typeFilter[type] !== false)
-        const visibleByType = nodes.filter((n) => typeFilter[n.type] !== false);
-        const visibleNodeIds = new Set(visibleByType.map((n) => n.id));
-
-        // Search: match by id, name, or label (case-insensitive)
-        const matchesSearch = (n: Node, q: string) => {
-            const t = q.toLowerCase();
-            return (
-                (n.id && String(n.id).toLowerCase().includes(t)) ||
-                (n.name && String(n.name).toLowerCase().includes(t)) ||
-                ((n as { label?: string }).label && String((n as { label?: string }).label).toLowerCase().includes(t))
-            );
-        };
-        const query = mapSearchQuery.trim();
-        const searchMatches = query
-            ? visibleByType.filter((n) => matchesSearch(n, query))
-            : visibleByType;
-
-        if (searchMatches.length === 1 && searchMatches[0].id !== selectedNode?.id) {
-            setSelectedNode(searchMatches[0]);
-        }
-
-        const effectiveNodeIds =
-            query && searchMatches.length > 1
-                ? new Set(searchMatches.map((n) => n.id))
-                : visibleNodeIds;
-        const effectiveNodes = nodes.filter((n) => effectiveNodeIds.has(n.id));
-        const effectiveValidLinks = validLinks.filter(
-            (l) =>
-                effectiveNodeIds.has((l.source as Node).id) &&
-                effectiveNodeIds.has((l.target as Node).id)
-        );
-
-        const simulation = d3.forceSimulation<Node>(effectiveNodes)
-            .force('link', d3.forceLink<Node, Link>(effectiveValidLinks).id(d => d.id).distance(150))
+        const simulation = d3.forceSimulation<Node>(nodes)
+            .force('link', d3.forceLink<Node, Link>(validLinks).id(d => d.id).distance(150))
             .force('charge', d3.forceManyBody().strength(-800))
             .force('center', d3.forceCenter(width / 2, height / 2))
             .force('collide', d3.forceCollide().radius(60));
@@ -870,7 +610,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
         const link = g.append('g')
             .attr('class', 'links')
             .selectAll('line')
-            .data(effectiveValidLinks)
+            .data(validLinks)
             .enter().append('line')
             .attr('stroke', (d: Link) => (d as Link & { is_anchor?: boolean }).is_anchor ? '#94a3b8' : '#888')
             .attr('stroke-width', (d: Link) => (d as Link & { is_anchor?: boolean }).is_anchor ? 1 : 1.5)
@@ -881,7 +621,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
         const node = g.append('g')
             .attr('class', 'nodes')
             .selectAll('.node')
-            .data(effectiveNodes)
+            .data(nodes)
             .enter().append('g')
             .attr('class', 'node')
             .style('opacity', d => d.is_active === false ? inactiveOpacity : 1)
@@ -932,7 +672,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                 // Color by diff status (KG-diff contract, same as KgDiffDiagramView)
                 const status = (d as any).diff_status;
                 if (status && KG_DIFF_COLORS[status as keyof typeof KG_DIFF_COLORS]) return KG_DIFF_COLORS[status as keyof typeof KG_DIFF_COLORS];
-                return getAgentColorForNodeType(d.type);
+                return typeConfig[d.type]?.color || '#444';
             })
             .attr('stroke', d => {
                 if (selectedNode && d.id === selectedNode.id) return '#fff';
@@ -1057,7 +797,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                 }
             }
         };
-    }, [data, viewMode, inactiveOpacity, diffData, selectedTimelineVersionId, timelineVersionDiff, selectedNode, compareViewMode, mapSearchQuery, typeFilter]);
+    }, [data, viewMode, inactiveOpacity, diffData, selectedNode, compareViewMode]);
 
     // Center map on selected node when it changes
     useEffect(() => {
@@ -1118,8 +858,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
         [draftArtifactNodes, approvedDecisionIds]
     );
 
-    // Artifacts View Component: KG artifacts (accepted) + pending proposals (draft) ΓÇö exclude drafts that were applied.
-    // Dedupe by metadata.artifact_id so the same document does not appear twice (e.g. base + enriched node for same file).
+    // Artifacts View Component: KG artifacts (accepted) + pending proposals (draft) ΓÇö exclude drafts that were applied
     const ArtifactsView = () => {
         const kgArtifacts = data?.nodes.filter(n => n.type === 'ARTIFACT') || [];
         const enrichedKg = kgArtifacts.map(artifact => {
@@ -1129,16 +868,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                 metadata: fullNode?.metadata || artifact.metadata || {}
             };
         });
-        const seenArtifactIds = new Set<string>();
-        const dedupedKg = enrichedKg.filter((n) => {
-            const aid = n.metadata?.artifact_id;
-            if (aid != null && aid !== '') {
-                if (seenArtifactIds.has(String(aid))) return false;
-                seenArtifactIds.add(String(aid));
-            }
-            return true;
-        });
-        const artifacts = [...draftsToShow, ...dedupedKg];
+        const artifacts = [...draftsToShow, ...enrichedKg];
 
         return (
             <ArtifactsListView
@@ -1152,8 +882,92 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
 
     return (
         <div className="h-full w-full flex flex-col bg-background overflow-hidden relative">
-            {/* History Panel - Slide In (hidden when decisions table is the timeline) */}
-            {!embeddedInDecisions && showHistory && kgHistory && (
+            {/* Toolbar */}
+            <div className="h-12 border-b border-border bg-muted/30 flex items-center justify-between px-4 z-20">
+                <div className="flex items-center gap-4">
+                    {kgHistory && (
+                        <>
+                            <UIButton
+                                variant="ghost"
+                                size="sm"
+                                className={cn(
+                                    "flex items-center gap-2 px-2.5 py-1 border rounded-md transition-colors",
+                                    showHistory ? "bg-blue-500/20 border-blue-500/40" : "bg-blue-500/10 border-blue-500/20 hover:bg-blue-500/20"
+                                )}
+                                onClick={() => setShowHistory(!showHistory)}
+                            >
+                                <span className="text-[10px] font-bold text-blue-500 tracking-wider">KG v{kgHistory.total}</span>
+                            </UIButton>
+                            <UIButton
+                                variant="ghost"
+                                size="sm"
+                                className={cn(
+                                    "flex items-center gap-2 px-2.5 py-1 border rounded-md transition-colors",
+                                    compareMode ? "bg-purple-500/20 border-purple-500/40" : "bg-purple-500/10 border-purple-500/20 hover:bg-purple-500/20"
+                                )}
+                                onClick={() => {
+                                    setCompareMode(!compareMode);
+                                    if (!compareMode) {
+                                        setShowHistory(true);
+                                    } else {
+                                        setCompareVersion1(null);
+                                        setCompareVersion2(null);
+                                        setDiffData(null);
+                                    }
+                                }}
+                            >
+                                <GitCompare className="h-3 w-3 text-purple-500" />
+                                <span className="text-[10px] font-bold text-purple-500 tracking-wider">Compare</span>
+                            </UIButton>
+                        </>
+                    )}
+                    <div className="h-4 w-px bg-border ml-2" />
+                    <div className="flex items-center gap-2 px-2">
+                        <label className="text-[10px] text-muted-foreground whitespace-nowrap">Inactive Opacity:</label>
+                        <input
+                            type="range"
+                            min="0"
+                            max="1"
+                            step="0.05"
+                            value={inactiveOpacity}
+                            onChange={(e) => setInactiveOpacity(parseFloat(e.target.value))}
+                            className="w-20 h-1.5 bg-muted rounded-lg appearance-none cursor-pointer accent-primary"
+                            title={`Inactive node opacity: ${Math.round(inactiveOpacity * 100)}%`}
+                        />
+                        <span className="text-[10px] text-muted-foreground w-8 text-right">{Math.round(inactiveOpacity * 100)}%</span>
+                    </div>
+                    <UIButton variant="ghost" size="sm" className="gap-2 text-muted-foreground hover:text-foreground" onClick={() => fetchData()}>
+                        <RefreshCw className={loading ? "h-3.5 w-3.5 animate-spin" : "h-3.5 w-3.5"} />
+                        <span className="text-xs">Refresh</span>
+                    </UIButton>
+                </div>
+                <div className="flex items-center gap-2">
+                    {data?.metadata.active_trigger && (
+                        <div className="flex items-center gap-2 px-3 py-1 bg-yellow-500/10 border border-yellow-500/20 rounded-full">
+                            <span className="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" />
+                            <span className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider">Active Trigger: {data.metadata.active_trigger}</span>
+                        </div>
+                    )}
+                    {activeVersion && (
+                        <div className="flex items-center gap-2 px-3 py-1 bg-purple-500/10 border border-purple-500/20 rounded-full">
+                            <span className="text-[10px] font-bold text-purple-500 uppercase tracking-wider">Historical: {activeVersion}</span>
+                            <UIButton variant="ghost" size="icon" className="h-4 w-4 ml-1 hover:bg-purple-500/20 rounded-full" onClick={() => fetchData()}>
+                                <RefreshCw className="h-2.5 w-2.5 text-purple-500" />
+                            </UIButton>
+                        </div>
+                    )}
+                    <div className="relative">
+                        <Search className="h-3.5 w-3.5 absolute left-2.5 top-1/2 -translate-y-1/2 text-muted-foreground" />
+                        <input
+                            placeholder="Search nodes..."
+                            className="bg-muted border border-border rounded-md py-1 pl-8 pr-3 text-xs focus:outline-none focus:border-primary/50 transition-all w-48 text-foreground"
+                        />
+                    </div>
+                </div>
+            </div>
+
+            {/* History Panel - Slide In */}
+            {showHistory && kgHistory && (
                 <div className="absolute top-12 left-0 bottom-0 w-80 bg-background/95 backdrop-blur-sm border-r border-border z-30 flex flex-col animate-in slide-in-from-left-4 duration-200">
                     <div className="p-4 border-b border-border flex justify-between items-center bg-muted/30">
                         <div>
@@ -1300,17 +1114,13 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                             )}
                         </div>
                     ) : (
-                        <div className="flex-1 overflow-y-auto p-2 space-y-1 flex flex-col">
+                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                             <div
                                 className={cn(
                                     "p-3 rounded-md cursor-pointer transition-colors flex flex-col gap-1",
                                     !activeVersion ? "bg-primary/10 border border-primary/20" : "hover:bg-muted"
                                 )}
-                                onClick={() => {
-                                    setSelectedTimelineVersionId(null);
-                                    setTimelineVersionDiff(null);
-                                    fetchData();
-                                }}
+                                onClick={() => fetchData()}
                             >
                                 <span className="text-xs font-semibold text-foreground flex items-center justify-between">
                                     Current State
@@ -1319,91 +1129,29 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                                 <span className="text-[10px] text-muted-foreground">Live Active Graph</span>
                             </div>
 
-                            {kgHistory.versions.map((v: any) => {
-                                const isDecision = kgDecisions.some((d: any) => d.kg_version_sha === v.id);
-                                return (
-                                    <div
-                                        key={v.id}
-                                        className={cn(
-                                            "p-3 rounded-md cursor-pointer transition-colors flex flex-col gap-1 border border-transparent",
-                                            activeVersion === v.id ? "bg-purple-500/10 border-purple-500/20" : "hover:bg-muted"
-                                        )}
-                                        onClick={() => {
-                                            setActiveVersion(v.id);
-                                            fetchData(v.id);
-                                            if (isDecision) {
-                                                setSelectedTimelineVersionId(v.id);
-                                                console.log('[WorldMapView] Timeline: selected decision version', { versionId: v.id });
-                                                fetchDiffForTimelineVersion(v.id);
-                                            } else {
-                                                setSelectedTimelineVersionId(null);
-                                                setTimelineVersionDiff(null);
-                                            }
-                                        }}
-                                    >
-                                        <span className="text-xs font-medium text-foreground">
-                                            {v.message || v.id}
-                                        </span>
-                                        <div className="flex items-center justify-between">
-                                            <span className="text-[10px] text-muted-foreground">{v.timestamp}</span>
-                                            {v.sha && (
-                                                <span className="text-[9px] text-muted-foreground/60 font-mono">{v.sha}</span>
-                                            )}
-                                        </div>
-                                        {isDecision && (
-                                            <span className="text-[9px] text-purple-600 dark:text-purple-400 mt-0.5 block">Decision</span>
+                            {kgHistory.versions.map((v: any) => (
+                                <div
+                                    key={v.id}
+                                    className={cn(
+                                        "p-3 rounded-md cursor-pointer transition-colors flex flex-col gap-1 border border-transparent",
+                                        activeVersion === v.id ? "bg-purple-500/10 border-purple-500/20" : "hover:bg-muted"
+                                    )}
+                                    onClick={() => fetchData(v.id)}
+                                >
+                                    <span className="text-xs font-medium text-foreground">
+                                        {v.message || v.id}
+                                    </span>
+                                    <div className="flex items-center justify-between">
+                                        <span className="text-[10px] text-muted-foreground">{v.timestamp}</span>
+                                        {v.sha && (
+                                            <span className="text-[9px] text-muted-foreground/60 font-mono">{v.sha}</span>
                                         )}
                                     </div>
-                                );
-                            })}
-
-                            {/* Diff for selected decision version (timeline view) */}
-                            {selectedTimelineVersionId && (
-                                <div className="mt-4 p-3 border-t border-border space-y-2">
-                                    <div className="text-[10px] font-bold text-muted-foreground uppercase">Diff for this version</div>
-                                    {loadingTimelineDiff && (
-                                        <div className="flex justify-center py-4">
-                                            <div className="h-6 w-6 border-2 border-primary border-t-transparent rounded-full animate-spin" />
-                                        </div>
-                                    )}
-                                    {!loadingTimelineDiff && timelineVersionDiff && (
-                                        <>
-                                            {/* Numeric summary (from API top-level summary) */}
-                                            {timelineVersionDiff.summary && (
-                                                <div className="space-y-1 text-xs p-2 rounded-md bg-muted/30 border border-border">
-                                                    <div className="flex justify-between">
-                                                        <span className="text-green-500">Added:</span>
-                                                        <span className="font-medium">{timelineVersionDiff.summary.added ?? 0}</span>
-                                                    </div>
-                                                    <div className="flex justify-between">
-                                                        <span className="text-yellow-500">Modified:</span>
-                                                        <span className="font-medium">{timelineVersionDiff.summary.modified ?? 0}</span>
-                                                    </div>
-                                                    <div className="flex justify-between">
-                                                        <span className="text-red-500">Removed:</span>
-                                                        <span className="font-medium">{timelineVersionDiff.summary.removed ?? 0}</span>
-                                                    </div>
-                                                    {timelineVersionDiff.summary.semanticSummary && (
-                                                        <p className="text-[10px] text-muted-foreground italic pt-1 border-t border-border mt-1">
-                                                            {timelineVersionDiff.summary.semanticSummary}
-                                                        </p>
-                                                    )}
-                                                </div>
-                                            )}
-                                            {/* Full diagram (nodes/edges list) */}
-                                            {timelineVersionDiff.diff && (
-                                                <KgDiffDiagramView payload={timelineVersionDiff.diff} isLoading={false} />
-                                            )}
-                                            {!loadingTimelineDiff && !timelineVersionDiff.diff && timelineVersionDiff.summary && (
-                                                <p className="text-xs text-muted-foreground">No structural diff (summary only).</p>
-                                            )}
-                                        </>
-                                    )}
-                                    {!loadingTimelineDiff && selectedTimelineVersionId && !timelineVersionDiff && (
-                                        <p className="text-xs text-muted-foreground">Loading diff from previous versionΓÇª</p>
+                                    {kgDecisions.some((d: any) => d.kg_version_sha === v.id) && (
+                                        <span className="text-[9px] text-purple-600 dark:text-purple-400 mt-0.5 block">Decision</span>
                                     )}
                                 </div>
-                            )}
+                            ))}
                         </div>
                     )}
                 </div>
@@ -1499,20 +1247,18 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                     </>
                 )}
 
-                        {/* Floating Controls - only when bottom panel is collapsed */}
-                        {bottomPanelCollapsed && (
-                            <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-20">
-                                <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
-                                    <ZoomIn className="h-4 w-4" />
-                                </UIButton>
-                                <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
-                                    <ZoomOut className="h-4 w-4" />
-                                </UIButton>
-                                <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
-                                    <Maximize className="h-4 w-4" />
-                                </UIButton>
-                            </div>
-                        )}
+                        {/* Floating Controls */}
+                        <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-20">
+                            <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
+                                <ZoomIn className="h-4 w-4" />
+                            </UIButton>
+                            <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
+                                <ZoomOut className="h-4 w-4" />
+                            </UIButton>
+                            <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
+                                <Maximize className="h-4 w-4" />
+                            </UIButton>
+                        </div>
                     </div>
 
                     {/* Detail Panel - Bottom, resizable height */}
@@ -1526,7 +1272,7 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                     </div>
                 </div>
             ) : (
-                <div ref={containerRef} className="flex-1 min-h-0 flex flex-col relative overflow-hidden" onClick={() => setSelectedNode(null)}>
+                <div ref={containerRef} className="flex-1 relative overflow-hidden" onClick={() => setSelectedNode(null)}>
                     {viewMode === 'artifacts' ? (
                         <ArtifactsView />
                     ) : (
@@ -1560,166 +1306,19 @@ export function WorldMapView({ embeddedInDecisions = false }: WorldMapViewProps
                         </>
                     )}
 
-                    {/* Floating Controls - only when bottom panel is collapsed */}
-                    {bottomPanelCollapsed && (
-                        <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-20">
-                            <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
-                                <ZoomIn className="h-4 w-4" />
-                            </UIButton>
-                            <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
-                                <ZoomOut className="h-4 w-4" />
-                            </UIButton>
-                            <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
-                                <Maximize className="h-4 w-4" />
-                            </UIButton>
-                        </div>
-                    )}
-                </div>
-            )}
-
-            {/* Map controls: only show when not embedded in Decisions tab */}
-            {!embeddedInDecisions && (
-            <div className={cn("border-t border-border bg-muted/30 z-20 shrink-0 flex flex-col", bottomPanelCollapsed ? "h-9" : "min-h-[52px]")}>
-                {bottomPanelCollapsed ? (
-                    <button
-                        type="button"
-                        onClick={() => setBottomPanelCollapsed(false)}
-                        className="h-full w-full flex items-center justify-center gap-2 px-4 text-[10px] font-medium text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors"
-                    >
-                        <ChevronUp className="h-3.5 w-3.5" />
-                        Map controls
-                    </button>
-                ) : (
-                    <div className="flex items-center gap-3 flex-wrap px-3 py-2">
-                        {/* Workflow strip (same order and colors as header) */}
-                        {workflowStrip && workflowStrip.nodes.length > 0 && (
-                            <div className="flex items-center gap-0.5 border border-border/50 rounded-md px-1.5 py-0.5 bg-background/50">
-                                {workflowStrip.nodes.map((node, i) => {
-                                    const color = getWorkflowNodeColor(node.id);
-                                    const isActive = workflowStrip.active_node === node.id;
-                                    return (
-                                        <span key={node.id} className="flex items-center shrink-0 gap-0.5">
-                                            <span
-                                                className={cn(
-                                                    "inline-block px-2 py-0.5 rounded text-[10px] font-medium whitespace-nowrap border border-transparent",
-                                                    isActive ? "text-foreground ring-1 ring-primary/40" : "text-muted-foreground"
-                                                )}
-                                                style={isActive ? { backgroundColor: `color-mix(in srgb, ${color} 22%, hsl(215,20%,25%))`, borderColor: `color-mix(in srgb, ${color} 55%, transparent)` } : undefined}
-                                                title={node.label}
-                                            >
-                                                {node.label}
-                                            </span>
-                                            {i < workflowStrip.nodes.length - 1 && <span className="text-muted-foreground/50 text-[10px] shrink-0">ΓåÆ</span>}
-                                        </span>
-                                    );
-                                })}
-                            </div>
-                        )}
-                        <div className="h-4 w-px bg-border shrink-0" />
-                        {/* Filter by type (hierarchy) */}
-                        {data?.nodes?.length ? (
-                            <div className="flex items-center gap-1.5 flex-wrap">
-                                <span className="text-[10px] text-muted-foreground font-medium uppercase tracking-wider shrink-0">Filter</span>
-                                {(() => {
-                                    const typesInData = new Set(data.nodes.map((n) => n.type));
-                                    return MAP_LEGEND_AGENT_HIERARCHY.map((agent) => {
-                                        const agentTypesPresent = agent.templates.flatMap((t) => t.types.filter((ty) => typesInData.has(ty)));
-                                        if (agentTypesPresent.length === 0) return null;
-                                        const isCollapsed = legendCollapsed[agent.agentId] === true;
-                                        const color = agentColors[agent.agentId] ?? '#888';
-                                        return (
-                                            <div key={agent.agentId} className="rounded-md overflow-hidden border border-border" style={{ borderColor: `color-mix(in srgb, ${color} 65%, transparent)` }}>
-                                                <button type="button" onClick={() => setLegendCollapsed((prev) => ({ ...prev, [agent.agentId]: !prev[agent.agentId] }))} className={cn("w-full inline-flex items-center gap-1.5 rounded-t-md px-2 py-0.5 text-[10px] font-semibold border-b border-border transition-colors bg-muted/30 hover:bg-muted/50 text-foreground")} style={{ backgroundColor: `color-mix(in srgb, ${color} 22%, hsl(215,20%,25%))` }}>
-                                                    {isCollapsed ? <ChevronRight className="h-3 w-3 text-muted-foreground shrink-0" /> : <ChevronDown className="h-3 w-3 text-muted-foreground shrink-0" />}
-                                                    <span>{agent.agentName}</span>
-                                                </button>
-                                                {!isCollapsed && (
-                                                    <div className="bg-background/50 p-1.5 pt-1 space-y-1">
-                                                        {agent.templates.map((tpl) => {
-                                                            const present = tpl.types.filter((ty) => typesInData.has(ty));
-                                                            if (present.length === 0) return null;
-                                                            return (
-                                                                <div key={tpl.templateName} className="pl-1">
-                                                                    <div className="text-[9px] font-medium text-muted-foreground mb-0.5">{tpl.templateName}</div>
-                                                                    <div className="flex flex-wrap gap-1">
-                                                                        {present.map((t) => {
-                                                                            const cfg = typeConfig[t] ?? { label: t };
-                                                                            const visible = typeFilter[t] !== false;
-                                                                            return (
-                                                                                <button key={t} type="button" onClick={(e) => { e.stopPropagation(); setTypeFilter((prev) => ({ ...prev, [t]: !(prev[t] !== false) })); }} className={cn("inline-flex items-center gap-1 rounded px-1.5 py-0.5 text-[10px] font-medium border transition-colors", visible ? "border-border bg-muted/50 hover:bg-muted text-foreground" : "border-transparent bg-muted/20 text-muted-foreground opacity-60")} title={visible ? `Hide ${cfg.label}` : `Show ${cfg.label}`}>
-                                                                                    <span className="w-2 h-2 rounded-full shrink-0" style={{ backgroundColor: color }} />
-                                                                                    {cfg.label}
-                                                                                </button>
-                                                                            );
-                                                                        })}
-                                                                    </div>
-                                                                </div>
-                                                            );
-                                                        })}
-                                                    </div>
-                                                )}
-                                            </div>
-                                        );
-                                    });
-                                })()}
-                            </div>
-                        ) : null}
-                        <div className="h-4 w-px bg-border shrink-0" />
-                        {/* Search */}
-                        <div className="relative shrink-0">
-                            <Search className="h-3.5 w-3.5 absolute left-2.5 top-1/2 -translate-y-1/2 text-muted-foreground" />
-                            <input value={mapSearchQuery} onChange={(e) => setMapSearchQuery(e.target.value)} placeholder="Search nodes..." className="bg-muted border border-border rounded-md py-1 pl-8 pr-3 text-xs focus:outline-none focus:border-primary/50 transition-all w-40 text-foreground" />
-                        </div>
-                        {/* Badges */}
-                        {data?.metadata?.active_trigger && (
-                            <div className="flex items-center gap-2 px-2 py-0.5 bg-yellow-500/10 border border-yellow-500/20 rounded-full shrink-0">
-                                <span className="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" />
-                                <span className="text-[10px] font-bold text-yellow-500 uppercase tracking-wider">Trigger: {data.metadata.active_trigger}</span>
-                            </div>
-                        )}
-                        {activeVersion && (
-                            <div className="flex items-center gap-2 px-2 py-0.5 bg-purple-500/10 border border-purple-500/20 rounded-full shrink-0">
-                                <span className="text-[10px] font-bold text-purple-500 uppercase tracking-wider">Historical: {activeVersion}</span>
-                                <UIButton variant="ghost" size="icon" className="h-4 w-4 hover:bg-purple-500/20 rounded-full" onClick={() => fetchData()}>
-                                    <RefreshCw className="h-2.5 w-2.5 text-purple-500" />
-                                </UIButton>
-                            </div>
-                        )}
-                        <div className="h-4 w-px bg-border shrink-0" />
-                        {/* Inactive + Refresh + KG v15 + Compare + Zoom */}
-                        <div className="flex items-center gap-2 flex-wrap">
-                            <div className="flex items-center gap-1.5">
-                                <label className="text-[10px] text-muted-foreground whitespace-nowrap">Inactive:</label>
-                                <input type="range" min="0" max="1" step="0.05" value={inactiveOpacity} onChange={(e) => setInactiveOpacity(parseFloat(e.target.value))} className="w-16 h-1.5 bg-muted rounded-lg appearance-none cursor-pointer accent-primary" title={`Inactive opacity: ${Math.round(inactiveOpacity * 100)}%`} />
-                                <span className="text-[10px] text-muted-foreground w-6 text-right">{Math.round(inactiveOpacity * 100)}%</span>
-                            </div>
-                            <UIButton variant="ghost" size="sm" className="h-7 gap-1.5 text-muted-foreground hover:text-foreground shrink-0" onClick={() => fetchData()}>
-                                <RefreshCw className={loading ? "h-3 w-3 animate-spin" : "h-3 w-3"} />
-                                <span className="text-[10px]">Refresh</span>
-                            </UIButton>
-                            {!embeddedInDecisions && kgHistory && (
-                                <>
-                                    <UIButton variant="ghost" size="sm" className={cn("h-7 gap-1.5 border rounded-md transition-colors shrink-0", showHistory ? "bg-blue-500/20 border-blue-500/40" : "bg-blue-500/10 border-blue-500/20 hover:bg-blue-500/20")} onClick={() => setShowHistory(!showHistory)}>
-                                        <span className="text-[10px] font-bold text-blue-500 tracking-wider">KG v{kgHistory.total}</span>
-                                    </UIButton>
-                                    <UIButton variant="ghost" size="sm" className={cn("h-7 gap-1.5 border rounded-md transition-colors shrink-0", compareMode ? "bg-purple-500/20 border-purple-500/40" : "bg-purple-500/10 border-purple-500/20 hover:bg-purple-500/20")} onClick={() => { setCompareMode(!compareMode); if (!compareMode) setShowHistory(true); else { setCompareVersion1(null); setCompareVersion2(null); setDiffData(null); } }}>
-                                        <GitCompare className="h-3 w-3 text-purple-500" />
-                                        <span className="text-[10px] font-bold text-purple-500 tracking-wider">Compare</span>
-                                    </UIButton>
-                                </>
-                            )}
-                            <div className="flex items-center gap-1 shrink-0">
-                                <UIButton variant="outline" size="icon" className="w-8 h-8 border-border text-muted-foreground hover:text-foreground rounded-md" title="Zoom in"><ZoomIn className="h-3.5 w-3.5" /></UIButton>
-                                <UIButton variant="outline" size="icon" className="w-8 h-8 border-border text-muted-foreground hover:text-foreground rounded-md" title="Zoom out"><ZoomOut className="h-3.5 w-3.5" /></UIButton>
-                                <UIButton variant="outline" size="icon" className="w-8 h-8 border-border text-muted-foreground hover:text-foreground rounded-md" title="Fit to view"><Maximize className="h-3.5 w-3.5" /></UIButton>
-                            </div>
-                        </div>
-                        <button type="button" onClick={() => setBottomPanelCollapsed(true)} className="ml-auto shrink-0 p-1.5 rounded text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors" title="Collapse map controls">
-                            <ChevronUp className="h-3.5 w-3.5" />
-                        </button>
+                    {/* Floating Controls */}
+                    <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-20">
+                        <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
+                            <ZoomIn className="h-4 w-4" />
+                        </UIButton>
+                        <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
+                            <ZoomOut className="h-4 w-4" />
+                        </UIButton>
+                        <UIButton variant="outline" size="icon" className="w-9 h-9 bg-background/50 border-border text-muted-foreground hover:text-foreground rounded-lg backdrop-blur-md">
+                            <Maximize className="h-4 w-4" />
+                        </UIButton>
                     </div>
-                )}
-            </div>
+                </div>
             )}
         </div>
     );
